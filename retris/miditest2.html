<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebAudioFont — GM MIDI Player (Minimal, working)</title>

  <!-- WebAudioFont player -->
  <script src="https://surikov.github.io/webaudiofont/npm/dist/WebAudioFontPlayer.js"></script>

  <!-- Large General MIDI instrument pack (contains many instruments incl. drums) -->
  <script src="https://surikov.github.io/webaudiofontdata/sound/0560_GeneralUserGS_sf2_file.js"></script>

  <style>
    body { background:#121212; color:#fff; font-family:system-ui,Segoe UI,Roboto,Arial; text-align:center; padding:40px; }
    input,button{ font-size:16px; padding:10px 14px; margin:8px; }
    button{ cursor:pointer; border-radius:8px; border:none; background:#00d3a7; color:#082; }
  </style>
</head>
<body>
  <h1>WebAudioFont GM MIDI Player (Minimal)</h1>
  <input id="midiFile" type="file" accept=".mid" />
  <br />
  <button id="playBtn">▶ Play</button>
  <button id="stopBtn">⏹ Stop</button>
  <p id="log">Select a .mid file and click Play</p>

  <script>
    const logEl = document.getElementById('log');
    function log(s){ console.log(s); logEl.textContent = s; }

    const AudioContextCtor = window.AudioContext || window.webkitAudioContext;
    const audioContext = new AudioContextCtor();
    const player = new WebAudioFontPlayer();

    // The variable name defined by the included GeneralUser GS file:
    // (the sound file script defines a global like _tone_0560_GeneralUserGS_sf2_file)
    const GM = window._tone_0560_GeneralUserGS_sf2_file;

    if (!GM) {
      log('ERROR: GeneralUser GS instrument variable not found. Check that the script loaded.');
    } else {
      log('GeneralUser GS instrument script loaded.');
    }

    document.getElementById('playBtn').addEventListener('click', async () => {
      const fileInput = document.getElementById('midiFile');
      const f = fileInput.files[0];
      if (!f) { alert('Choose a .mid file first'); return; }

      await audioContext.resume(); // user gesture / resume

      const arrayBuffer = await f.arrayBuffer();
      player.cancelQueue(audioContext); // stop any previous playback

      log('Decoding instrument(s) — waiting for samples to load...');

      // decodeAfterLoading ensures the instrument is ready
      player.loader.decodeAfterLoading(audioContext, GM, () => {
        try {
          log('Instrument decoded — playing MIDI now');
          player.playMidiArrayBuffer(audioContext, arrayBuffer, audioContext.destination);
        } catch (err) {
          console.error(err);
          log('Playback error: ' + (err && err.message ? err.message : err));
        }
      });
    });

    document.getElementById('stopBtn').addEventListener('click', () => {
      player.cancelQueue(audioContext);
      log('Stopped.');
    });
  </script>
</body>
</html>
